
---

Этот скрипт предназначен для работы с VCF файлами (Variant Call Format) и таблицами Excel. Он поддерживает две основные команды: `extract` для извлечения аннотаций из VCF файлов и их сохранения в Excel, и `update` для обновления существующих Excel таблиц данными из VCF файлов. Обе команды используют параллельную обработку для повышения производительности и могут отображать прогресс выполнения.

---

## Установка

Скрипт поставляется в виде Python-пакета, который можно установить локально с помощью команды:

```bash
pip install .
```

**Примечание**: Для выполнения этой команды необходимо находиться в директории, содержащей файл `setup.py` или аналогичный конфигурационный файл, который определяет структуру пакета.

При установке через `pip` автоматически устанавливаются все необходимые зависимости:

- `pandas` — для работы с таблицами.
- `pysam` — для чтения VCF файлов.
- `openpyxl` — для записи в Excel.
- `tqdm` — для отображения прогресс-бара.

Если вы предпочитаете установить зависимости вручную, используйте команду:

```bash
pip install pandas pysam openpyxl tqdm
```

---

## Использование

После установки пакет можно использовать через командную строку. Поддерживаются две команды: `extract` и `update`.

### Команда `extract`

Команда `extract` извлекает аннотации из VCF файла и сохраняет их в новый Excel файл.

#### Синтаксис

```bash
python3 vcf2table.py extract -i <input_vcf> -o <output_excel> [-p] [-th <threads>]
```

#### Аргументы

- `-i, --input` (обязательный): Путь к входному VCF файлу.
- `-o, --output` (обязательный): Путь к выходному Excel файлу.
- `-p, --progress` (опциональный): Включает отображение прогресс-бара во время обработки и сохранения.
- `-th, --threads` (опциональный): Количество потоков для параллельной обработки (по умолчанию 4).

#### Пример

```bash
python3 vcf2table.py extract -i input.vcf -o output.xlsx -p -th 8
```

В этом примере аннотации извлекаются из файла `input.vcf` и сохраняются в `output.xlsx`. Прогресс отображается, а обработка выполняется в 8 потоков.

#### Что делает команда?

1. Загружает таблицу признаков из файла `tables/feature_table.tsv`.
2. Обрабатывает записи VCF файла параллельно, извлекая аннотации.
3. Сохраняет результат в Excel файл с колонками:
   - `POS` — позиция варианта.
   - `REF` — референсный аллель.
   - `Allele` — альтернативный аллель.
   - `Annotation` — тип аннотации.
   - `Putative_impact` — предполагаемое воздействие.
   - `Gene Name` — имя гена.
   - `Gene ID` — идентификатор гена.
   - `name` — имя, связанное с locus_tag.
   - `Feature type` — тип признака.
   - `Transcript biotype` — тип транскрипта.
   - `HGVS.c` — нотация HGVS для кДНК.
   - `HGVS.p` — нотация HGVS для белка.
   - `cDNA_position / cDNA_len` — позиция в кДНК.
   - `CDS_position / CDS_len` — позиция в кодирующей последовательности.
   - `Protein_position / Protein_len` — позиция в белке.
   - `Errors` — ошибки или предупреждения.

---

### Команда `update`

Команда `update` обновляет существующую Excel таблицу данными из одного или нескольких VCF файлов.

#### Синтаксис

```bash
python3 vcf2table.py update -v <vcf_files> -t <input_excel> -o <output_excel> [-p] [-th <threads>]
```

#### Аргументы

- `-v, --vcfs` (обязательный): Список путей к VCF файлам (можно указать несколько через пробел).
- `-t, --table` (обязательный): Путь к исходной Excel таблице.
- `-o, --output` (обязательный): Путь к выходному Excel файлу с обновлёнными данными.
- `-p, --progress` (опциональный): Включает отображение прогресс-бара во время обработки.
- `-th, --threads` (опциональный): Количество потоков для параллельной обработки (по умолчанию 4).

#### Пример

```bash
python3 vcf2table.py update -v file1.vcf file2.vcf -t input.xlsx -o updated.xlsx -p -th 8
```

В этом примере таблица `input.xlsx` обновляется данными из `file1.vcf` и `file2.vcf`, результат сохраняется в `updated.xlsx` с отображением прогресса и использованием 8 потоков.

#### Что делает команда?

1. Читает исходную Excel таблицу и устанавливает индекс по колонке `POS`.
2. Извлекает данные (`POS`, `REF`, `Allele`) из VCF файлов параллельно.
3. Добавляет в таблицу новые колонки с именами, соответствующими названиям VCF файлов (без расширения), и значениями аллелей (`Allele`).
4. Сохраняет обновлённую таблицу в новый Excel файл.

---

## Примечания

- **Производительность**: Использование аргумента `-th` позволяет настроить количество потоков для ускорения обработки больших файлов.
- **Прогресс**: Флаг `-p` включает отображение прогресс-бара. Для файлов с более чем 100,000 строк прогресс отключается для ускорения записи.
- **Требования к файлам**: Для команды `extract` необходим файл `tables/feature_table.tsv` с данными (`symbol`, `locus_tag`, `name`) для аннотаций.
- **Обработка ошибок**: В режиме `update` при ошибке чтения одного из VCF файлов скрипт выведет сообщение и продолжит работу с остальными файлами.

---

Теперь справка включает информацию об установке через `pip install .`, что делает процесс настройки скрипта более понятным и удобным для пользователей. Если у вас есть дополнительные вопросы или пожелания, дайте знать!
