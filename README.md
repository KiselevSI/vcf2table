
Данный скрипт предназначен для работы с файлами формата VCF (Variant Call Format) и таблицами Excel. Он позволяет извлекать аннотации из VCF файлов и обновлять существующие Excel таблицы данными из VCF. Скрипт использует параллельную обработку для ускорения работы и поддерживает отображение прогресса выполнения.

---

## Установка

Перед использованием скрипта убедитесь, что у вас установлены необходимые библиотеки. Установите их с помощью команды:

```bash
pip install pandas pysam openpyxl tqdm
```

Эти библиотеки обеспечивают работу с таблицами (`pandas`), чтение VCF файлов (`pysam`), запись в Excel (`openpyxl`) и отображение прогресс-бара (`tqdm`).

---

## Использование

Скрипт поддерживает две основные команды: `extract` и `update`. Запуск осуществляется через командную строку с использованием Python.

### Команда `extract`

Извлекает аннотации из VCF файла и сохраняет их в новый Excel файл.

#### Синтаксис

```bash
python script.py extract -i <input_vcf> -o <output_excel> [-p] [-th <threads>]
```

#### Аргументы

- `-i, --input` (обязательный): Путь к входному VCF файлу.
- `-o, --output` (обязательный): Путь к выходному Excel файлу.
- `-p, --progress` (опциональный): Включает отображение прогресс-бара во время обработки и сохранения.
- `-th, --threads` (опциональный): Количество потоков для параллельной обработки (по умолчанию 4).

#### Пример

```bash
python script.py extract -i input.vcf -o output.xlsx -p -th 8
```

Этот пример извлекает аннотации из `input.vcf`, сохраняет их в `output.xlsx`, отображает прогресс и использует 8 потоков.

---

### Команда `update`

Обновляет существующую Excel таблицу данными из одного или нескольких VCF файлов.

#### Синтаксис

```bash
python script.py update -v <vcf_files> -t <input_excel> -o <output_excel> [-p] [-th <threads>]
```

#### Аргументы

- `-v, --vcfs` (обязательный): Список путей к VCF файлам (можно указать несколько через пробел).
- `-t, --table` (обязательный): Путь к исходной Excel таблице.
- `-o, --output` (обязательный): Путь к выходному Excel файлу с обновленными данными.
- `-p, --progress` (опциональный): Включает отображение прогресс-бара во время обработки.
- `-th, --threads` (опциональный): Количество потоков для параллельной обработки (по умолчанию 4).

#### Пример

```bash
python script.py update -v file1.vcf file2.vcf -t input.xlsx -o updated.xlsx -p -th 8
```

Этот пример обновляет таблицу `input.xlsx` данными из `file1.vcf` и `file2.vcf`, сохраняет результат в `updated.xlsx`, отображает прогресс и использует 8 потоков.

---

## Основные функции

### `extract_annotations`

Извлекает аннотации из VCF файла и сохраняет их в Excel. Процесс включает:

1. Загрузку таблиц признаков из файла `tables/feature_table.tsv`.
2. Параллельную обработку записей VCF с использованием нескольких потоков.
3. Сохранение результатов в Excel файл:
   - Для файлов с количеством строк > 100,000 используется быстрая запись без прогресса.
   - Для меньших файлов доступна запись с прогресс-баром (если указан флаг `-p`).

Результат содержит следующие колонки:
- `POS` — позиция варианта.
- `REF` — референсный аллель.
- `Allele` — альтернативный аллель.
- `Annotation` — тип аннотации.
- `Putative_impact` — предполагаемое воздействие.
- `Gene Name` — имя гена.
- `Gene ID` — идентификатор гена.
- `name` — имя, связанное с locus_tag.
- `Feature type` — тип признака.
- `Transcript biotype` — тип транскрипта.
- `HGVS.c` — нотация HGVS для кДНК.
- `HGVS.p` — нотация HGVS для белка.
- `cDNA_position / cDNA_len` — позиция в кДНК.
- `CDS_position / CDS_len` — позиция в кодирующей последовательности.
- `Protein_position / Protein_len` — позиция в белке.
- `Errors` — ошибки или предупреждения.

---

### `update_excel_with_vcfs`

Обновляет существующую Excel таблицу данными из VCF файлов. Процесс включает:

1. Чтение исходной Excel таблицы и установка индекса по колонке `POS`.
2. Параллельную обработку VCF файлов для извлечения данных (колонки `POS`, `REF`, `Allele`).
3. Добавление новых колонок в таблицу, где имя колонки соответствует имени VCF файла (без расширения), а значения — это аллели (`Allele`).
4. Сохранение обновленной таблицы в новый Excel файл.

---

## Примечания

- **Производительность**: Скрипт использует `ThreadPoolExecutor` для параллельной обработки, что ускоряет работу с большими файлами. Количество потоков можно настроить с помощью аргумента `-th`.
- **Прогресс**: Если указан флаг `-p`, прогресс отображается с помощью библиотеки `tqdm`. Для больших файлов (>100,000 строк) прогресс отключается для ускорения записи.
- **Требования к файлам**: Убедитесь, что файл `tables/feature_table.tsv` существует и содержит необходимые данные (`symbol`, `locus_tag`, `name`) для аннотаций.
- **Обработка ошибок**: При ошибке чтения VCF файла в режиме `update` скрипт выведет сообщение об ошибке и продолжит работу с оставшимися файлами.

---
